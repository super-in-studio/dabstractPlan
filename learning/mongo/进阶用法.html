<attachment contenteditable="false" data-atts="%5B%5D" data-aid=".atts-76d70fb1-0f98-4117-92d4-e5d9dfa108f8"></attachment><p>1.去重</p><p><br></p><p>db.productmenucategory.aggregate([</p><p><br></p><p>&nbsp;&nbsp;{$group: { _id:{name:"$tag.SHELTERNAME",address:"$tag.ADDRESS"}, total : { $sum : 1},dups: {$addToSet: '$_id'}}},&nbsp;&nbsp;&nbsp;//分组</p><p><br></p><p>{$match: { total:{"$gt":1}}},&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//筛选</p><p><br></p><p>//需要显示的字段</p><p>&nbsp;&nbsp;{$project: {</p><p>&nbsp;&nbsp;&nbsp;&nbsp;_id :1,</p><p>&nbsp;&nbsp;&nbsp;&nbsp;totol:{$districe:["$total",1]}</p><p>&nbsp;&nbsp;&nbsp;&nbsp;type:"type"</p><p>&nbsp;&nbsp;}},</p><p>&nbsp;&nbsp;{$group: { _id:{type:"$type"}, num : { $sum : "$total"}}}</p><p>],{ allowDiskUse: true })</p><p><br></p><p>2.表联合</p><p>db.productstorecategory.aggregate([</p><p>{$match: { brandId:26001241}},</p><p>{$lookup:{</p><p>&nbsp;&nbsp;from:"store",</p><p>&nbsp;&nbsp;localField:"storeId",</p><p>&nbsp;&nbsp;foreignField:"storeId",</p><p>&nbsp;&nbsp;as: "storeDate"</p><p>}},</p><p>{$lookup:{</p><p>&nbsp;&nbsp;from:"productmenucategory",</p><p>&nbsp;&nbsp;localField:"categoryId",</p><p>&nbsp;&nbsp;foreignField:"uid",</p><p>&nbsp;&nbsp;as: "categoryDate"</p><p>}},</p><p>{$project:{storeId:1,categoryId:1,"storeDate.storeName":1,"categoryDate.name":1}},</p><p>])</p><p><br></p><p>3.脚本</p><p>var list=db.productmenu.find({categoryId:{$in:[800002346,800004141</p><p>,800004308</p><p>,800004600</p><p>,800004611</p><p>,800004618</p><p>,800004628</p><p>]},status:1});</p><p>while(list.hasNext()){</p><p>&nbsp;&nbsp;var obj=list.next();</p><p>&nbsp;&nbsp;var channelArray=eval(obj.channels);</p><p>&nbsp;&nbsp;var printMsg = ""</p><p>&nbsp;&nbsp;printMsg = "餐单id:"+obj.uid +",餐单名称"+ obj.name+",是否默认餐单:"+obj.isDefault+",餐单分类id:"+obj.categoryId+",渠道信息:\n";</p><p>&nbsp;&nbsp;for(var i in channelArray){</p><p>&nbsp;&nbsp;&nbsp;&nbsp;var clientType = channelArray[i].clientType ;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;var sendTypes = eval(channelArray[i].sendTypes) ;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;var sysfromtypes = db.sysfromtype.find({fromTypeId:clientType})</p><p>&nbsp;&nbsp;&nbsp;&nbsp;printMsg = printMsg + sysfromtypes[0].name + "业务类型-[";</p><p>&nbsp;&nbsp;&nbsp;&nbsp;for(var j in sendTypes){</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var sendType = sendTypes[j]</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(sendType == 1)</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printMsg = printMsg +"外卖";</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(sendType == 2)</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printMsg = printMsg +"自取";</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(sendType == 3)</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printMsg = printMsg +"堂食";</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(sendType == 4)</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printMsg = printMsg +"外卖预约";</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(j != (sendTypes.length-1) ){</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printMsg = printMsg +"|"</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else{</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printMsg = printMsg +"]\n" ;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;}</p><p>&nbsp;&nbsp;}</p><p>&nbsp;&nbsp;&nbsp;</p><p>&nbsp;&nbsp;print(printMsg) ;</p><p>&nbsp;&nbsp;&nbsp;</p><p>}</p><p><br></p>