<attachment contenteditable="false" data-atts="%5B%5D" data-aid=".atts-6d0ff9fc-5f88-4fbe-8dc0-2522405f7c8f"></attachment><p>1，入口com.lxtx.im.api.web.api.app.ApiRedPacketController.send(RedPacketSendReq)</p><p>1，获取发红包的用户钱包Id</p><p>2,根据前端入参判断 判断是否为个人红包或者是群组红包</p><p>2.1 个人红包逻辑：</p><p>2.1.1, 判断接收人的钱包是否被发送人拉黑</p><p>2.1.2，如果不是，获取接收人的钱包id</p><p>2.1.3,获取的特殊国家列表,获取特殊处理国家显示币种,&nbsp;获取好友国家列表</p><p>2.1.4 判断转账接收方所在的国家是否是特殊列表中的国家，如果是则提示 对方无法收款.</p><p>2.1.5  判断发送者钱包密码是否正确</p><p>2.1.6  获取手续费并与前端计算值判断</p><p>2.1.7  以上判断都通过后，用发送者钱包id获取锁</p><p>2.1.8 判断发送者钱包的余额是否充足</p><p>2.1.9 扣减发送者钱包余额</p><p>2.1.10 设置红包信息</p><p>2.1.11 保存红包信息到数据库同时保存到redis里</p><p>2.1.12  保存 手续费流水到数据库</p><p>2.1.13   保存 资金操作到数据库</p><p>2.1.13  查询币种图标</p><p>2.1.14 如果发红包金额大于交易最大金额，给管理员推送消息</p><p>2.1.15 返回红包信息给前端</p><p>-----------------------------------------群组红包-------------------------------------------------------</p><p>2.2.1 群组平均红包逻辑：</p><p><br></p><p><br></p><p><br></p><p> ------------涉及资产修改公共方法UserCoinServiceImpl.updateUserAsset(...)--------------</p><ul><li>构建币种资产对象</li><li>判断用户转账方是否被锁，被锁后从DB 拿回账户数据</li><li> 如果没有账户就新建一个</li><li>币种资产对象的余额+账户余额 ，如果为负数就报余额不足</li><li>币种资产对象的冻结资金+账户余额 ，如果为负数就报余额不足</li><li>币种资产对象的锁定资金+账户余额 ，如果为负数就报余额不足</li><li>设置资金的余额</li><li>失败递归重试</li><li>成功的话 就更新资产和发mq</li></ul><p><br></p><p><br></p>